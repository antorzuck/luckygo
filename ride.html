<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LuckyGO â€“ Bangladesh</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: 'hsl(142,72%,35%)', light: 'hsl(142,60%,48%)', fore: '#ffffff' },
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        }
      }
    }
  </script>

  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; background: #f1f5f9; color: #0f172a; overflow: hidden; }

    /* â”€â”€ MAP â”€â”€ */
    #map { width: 100%; height: 100%; }
    .leaflet-container { font-family: 'Inter', sans-serif; }
    .leaflet-control-zoom { border: none !important; box-shadow: 0 4px 16px rgba(0,0,0,.12) !important; }
    .leaflet-control-zoom a { border-radius: 8px !important; border: none !important; color: #0f172a !important; }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes slideUp   { from { transform: translateY(16px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn    { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pingAnim  { 0% { transform: scale(1); opacity: .6; } 100% { transform: scale(2.2); opacity: 0; } }
    @keyframes sheetUp   { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .anim-slide-up  { animation: slideUp .4s cubic-bezier(.16,1,.3,1); }
    .anim-fade-in   { animation: fadeIn .3s ease; }
    .ping-anim      { animation: pingAnim 1.4s ease-out infinite; }

    /* â”€â”€ LAYOUT â”€â”€ */
    #app {
      display: flex;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
    }

    /* â”€â”€ DESKTOP sidebar â”€â”€ */
    #sidebar {
      width: 360px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      background: white;
      border-right: 1px solid #e2e8f0;
      z-index: 20;
      transition: transform .3s ease;
    }
    #sidebar.hidden-desk { transform: translateX(-100%); width: 0; overflow: hidden; border: none; }

    /* â”€â”€ MAP AREA â”€â”€ */
    #map-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    /* â”€â”€ MOBILE overrides â”€â”€ */
    @media (max-width: 639px) {
      #app { flex-direction: column; }

      #sidebar {
        /* on mobile the sidebar is a bottom sheet */
        position: fixed;
        bottom: 0; left: 0; right: 0;
        width: 100% !important;
        height: auto;
        max-height: 65vh;
        border-right: none;
        border-top: 1px solid #e2e8f0;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 32px rgba(0,0,0,.12);
        z-index: 300;
        transform: translateY(0) !important; /* always visible */
        overflow: hidden;
      }

      /* map takes full viewport on mobile */
      #map-area {
        position: fixed;
        inset: 0;
        height: 100dvh;
        z-index: 1;
      }

      /* push map content up so bottom sheet doesn't cover it */
      #map-area::after {
        content: '';
        display: block;
        height: 65vh;
      }

      #sidebar-toggle { display: none !important; }

      /* drag handle */
      #drag-handle {
        display: block;
      }
    }

    #drag-handle {
      display: none;
      width: 40px; height: 4px;
      background: #cbd5e1;
      border-radius: 2px;
      margin: 10px auto 6px;
      flex-shrink: 0;
    }

    /* â”€â”€ scrollbar â”€â”€ */
    .panel-scroll { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

    /* â”€â”€ toggle switch â”€â”€ */
    .toggle-track { position: relative; width: 56px; height: 28px; border-radius: 14px; transition: background .3s; cursor: pointer; flex-shrink: 0; }
    .toggle-thumb { position: absolute; top: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,.2); transition: left .3s; }

    /* â”€â”€ location dropdowns â”€â”€ */
    .loc-dropdown { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* â”€â”€ map cursor â”€â”€ */
    .cursor-cross { cursor: crosshair !important; }

    /* â”€â”€ map hint badge â”€â”€ */
    #map-hint {
      position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: #0f172a; color: white;
      padding: 8px 18px; border-radius: 999px; font-size: 13px; font-weight: 600;
      pointer-events: none; box-shadow: 0 4px 16px rgba(0,0,0,.25); white-space: nowrap;
    }

    /* â”€â”€ search input container â€” never destroyed on re-render â”€â”€ */
    #pickup-search-wrap, #dropoff-search-wrap {
      display: none;
      margin-top: 4px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.1);
      overflow: hidden;
      position: relative;
      z-index: 10;
    }
    #pickup-search-wrap.visible, #dropoff-search-wrap.visible { display: block; }

    .search-header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-bottom: 1px solid #e2e8f0;
    }
    .search-header input {
      flex: 1; font-size: 13px; border: none; outline: none;
      background: transparent; font-family: 'Inter', sans-serif;
      min-width: 0;
    }
    .search-header button { background: none; border: none; cursor: pointer; color: #94a3b8; font-size: 16px; padding: 0 2px; }
  </style>

<style>
	@font-face {
		font-family: 'CameraPlainVariable';
		src: url('https://cdn.gpteng.co/mcp-widgets/v1/fonts/CameraPlainVariable.woff2') format('woff2');
		font-weight: 100 900;
		font-style: normal;
		font-display: swap;
	}

	#lovable-badge {
		--badge-bg: #1b1b1b;
		--badge-text: #c5c1b9;
		--badge-text-hover: #dcdad5;
		--badge-radius: 6px;
		--badge-padding: 8px;
		--badge-gap: 6px;
		--badge-shadow: 
			0 0 0 1px rgba(0, 0, 0, 0.88),
			0 1px 0 0 rgba(0, 0, 0, 0.04),
			0 2px 2px -1px rgba(0, 0, 0, 0.08),
			0 4px 4px -2px rgba(0, 0, 0, 0.08),
			0 8px 8px -4px rgba(0, 0, 0, 0.08),
			0 16px 16px -8px rgba(0, 0, 0, 0.08);
		--badge-transition-duration: 0.2s;
		--badge-transition-easing: cubic-bezier(0.16, 1, 0.32, 1);
		--focus-color: #575ECF;
		--focus-offset: 2px;
		--focus-width: 2px;
		
		position: fixed;
		bottom: 12px;
		right: 12px;
		height: 24px;
		display: flex;
		align-items: center;
		z-index: 1000000;
		background-color: var(--badge-bg);
		color: var(--badge-text);
		border-radius: var(--badge-radius);
		box-shadow: var(--badge-shadow);
		font-size: 12px;
		font-family: CameraPlainVariable, "CameraPlainVariable Fallback", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		font-weight: 400 !important;
		text-transform: none !important;
		font-feature-settings: normal !important;
		transform: translateZ(0);
		will-change: transform, opacity;
	}

	#lovable-badge-cta {
		display: flex;
		align-items: center;
		gap: var(--badge-gap);
		padding: 0 var(--badge-padding);
		height: 100%;
		color: inherit;
		text-decoration: none;
		white-space: nowrap;
		border-radius: var(--badge-radius) 0 0 var(--badge-radius);
		transition: 
			background-color var(--badge-transition-duration) ease,
			color var(--badge-transition-duration) ease,
			transform 0.1s ease;
	}

	#lovable-badge-cta:hover {
		background: rgba(255, 255, 255, 0.04);
		color: var(--badge-text-hover);
	}

	#lovable-badge-cta:active {
		transform: scale(0.98);
	}

	#lovable-badge-cta:focus {
		outline: none;
	}

	#lovable-badge-cta:focus-visible {
		outline: var(--focus-width) solid var(--focus-color);
		outline-offset: var(--focus-offset);
		z-index: 1;
	}

	#lovable-badge-text {
		line-height: 1;
	}

	#lovable-badge-divider {
		width: 1px;
		height: 24px;
		background-color: rgba(255, 255, 255, 0.04);
		flex-shrink: 0;
	}

	#lovable-badge-close {
		width: 24px;
		height: 24px;
		min-width: 24px;
		min-height: 24px;
		cursor: pointer;
		background: none;
		border: none;
		padding: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 0 var(--badge-radius) var(--badge-radius) 0;
		flex-shrink: 0;
		transition: 
			background-color var(--badge-transition-duration) ease,
			transform 0.1s ease;
	}

	#lovable-badge-close:hover {
		background: rgba(255, 255, 255, 0.04);
	}

	#lovable-badge-close:active {
		transform: scale(0.92);
	}

	#lovable-badge-close:focus {
		outline: none;
	}

	#lovable-badge-close:focus-visible {
		outline: var(--focus-width) solid var(--focus-color);
		outline-offset: calc(var(--focus-offset) * -1);
		z-index: 1;
	}

	#lovable-badge-close svg path {
		fill: var(--badge-text);
		transition: fill var(--badge-transition-duration) ease;
	}

	#lovable-badge-close:hover svg path {
		fill: var(--badge-text-hover);
	}

	@media (prefers-reduced-motion: reduce) {
		#lovable-badge-cta,
		#lovable-badge-close,
		#lovable-badge-close svg path {
			transition: none;
		}
		
		#lovable-badge-cta:active,
		#lovable-badge-close:active {
			transform: none;
		}
	}

	@media (prefers-contrast: high) {
		#lovable-badge {
			--badge-bg: #000;
			--badge-text: #fff;
			--badge-text-hover: #fff;
			border: 2px solid currentColor;
		}
		
		#lovable-badge-cta:focus-visible,
		#lovable-badge-close:focus-visible {
			outline-width: 3px;
		}
	}
</style>
<meta name="twitter:image" content="https://pub-bb2e103a32db4e198524a2e9ed8f35b4.r2.dev/88db1492-acad-46b9-9624-eb091224072c/id-preview-7d3f3677--87858158-8bf0-4c92-9a24-7f9a97031eae.lovable.app-1771568203984.png" /></head>
<body>

<div id="app">

  <!-- ===== SIDEBAR / BOTTOM-SHEET ===== -->
  <div id="sidebar">
    <!-- mobile drag handle -->
    <div id="drag-handle"></div>

    <!-- Header -->
    <div style="padding:14px 16px 12px;border-bottom:1px solid #e2e8f0;flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <div style="width:32px;height:32px;background:hsl(142,72%,35%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;">ğŸš—</div>
        <div>
          <div style="font-weight:800;font-size:16px;line-height:1.2;">LuckyGO</div>
          <div style="font-size:11px;color:#64748b;">Bangladesh</div>
        </div>
      </div>
      <!-- Mode toggle -->
      <div style="display:flex;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;">
        <button id="btn-rider-mode" onclick="switchMode('rider')"
          style="flex:1;padding:9px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;">
          ğŸ™‹ Rider
        </button>
        <button id="btn-driver-mode" onclick="switchMode('driver')"
          style="flex:1;padding:9px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;">
          ğŸš˜ Driver
        </button>
      </div>
    </div>

    <!-- Persistent search inputs (not destroyed on render) -->
    <div id="pickup-search-wrap">
      <div class="search-header">
        <span style="color:#94a3b8;">ğŸ”</span>
        <input id="pickup-search-input" placeholder="Type any location & press Enter..." oninput="filterPickup(this.value)" onkeydown="handlePickupKey(event)" />
        <button onclick="submitPickupText()" title="Use this location" style="background:hsl(142,72%,35%);color:white;border:none;cursor:pointer;border-radius:6px;padding:3px 8px;font-size:12px;font-weight:600;">Use</button>
        <button onclick="closePickupList()">âœ•</button>
      </div>
      <div id="pickup-hint" style="font-size:11px;color:#94a3b8;padding:4px 12px 6px;display:none;">ğŸ’¡ Press Enter or tap <b>Use</b> to set any custom location name</div>
      <div class="loc-dropdown" id="pickup-results"></div>
    </div>

    <div id="dropoff-search-wrap">
      <div class="search-header">
        <span style="color:#94a3b8;">ğŸ”</span>
        <input id="dropoff-search-input" placeholder="Type any location & press Enter..." oninput="filterDropoff(this.value)" onkeydown="handleDropoffKey(event)" />
        <button onclick="submitDropoffText()" title="Use this location" style="background:hsl(142,72%,35%);color:white;border:none;cursor:pointer;border-radius:6px;padding:3px 8px;font-size:12px;font-weight:600;">Use</button>
        <button onclick="closeDropoffList()">âœ•</button>
      </div>
      <div id="dropoff-hint" style="font-size:11px;color:#94a3b8;padding:4px 12px 6px;display:none;">ğŸ’¡ Press Enter or tap <b>Use</b> to set any custom location name</div>
      <div class="loc-dropdown" id="dropoff-results"></div>
    </div>

    <!-- Panel content -->
    <div class="panel-scroll" id="panel-content"></div>
  </div>

  <!-- ===== MAP AREA ===== -->
  <div id="map-area">
    <!-- Sidebar toggle (desktop only) -->
    <button onclick="toggleSidebar()" id="sidebar-toggle"
      style="position:absolute;top:14px;left:14px;z-index:1000;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:9px 11px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);font-size:16px;">
      â˜°
    </button>

    <!-- Location badge -->
    <div style="position:absolute;top:14px;right:14px;z-index:1000;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:8px 14px;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
      <span style="font-size:13px;">ğŸ“</span>
      <span style="font-size:13px;font-weight:600;">Dhaka, BD</span>
    </div>

    <!-- Map click hint -->
    <div id="map-hint" style="display:none;"></div>

    <!-- Map -->
    <div id="map"></div>
  </div>
</div>

<!-- ===== SCRIPT ===== -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DHAKA_CENTER = [23.7808, 90.4093];

const DHAKA_LOCATIONS = [
  { name:"Gulshan 1",    lat:23.7816, lng:90.4152 },
  { name:"Gulshan 2",    lat:23.7954, lng:90.4142 },
  { name:"Dhanmondi",    lat:23.7461, lng:90.3742 },
  { name:"Motijheel",    lat:23.7274, lng:90.4173 },
  { name:"Uttara",       lat:23.8759, lng:90.3795 },
  { name:"Mirpur 10",    lat:23.8057, lng:90.3661 },
  { name:"Banani",       lat:23.7937, lng:90.4066 },
  { name:"Mohakhali",    lat:23.7794, lng:90.4044 },
  { name:"Shahbagh",     lat:23.7389, lng:90.3954 },
  { name:"New Market",   lat:23.7328, lng:90.3853 },
  { name:"Rampura",      lat:23.7592, lng:90.4342 },
  { name:"Badda",        lat:23.7800, lng:90.4283 },
  { name:"Bashundhara",  lat:23.8134, lng:90.4290 },
  { name:"Shyamoli",     lat:23.7697, lng:90.3567 },
  { name:"Azimpur",      lat:23.7244, lng:90.3836 },
  { name:"Airport",      lat:23.8433, lng:90.3978 },
  { name:"Panthapath",   lat:23.7511, lng:90.3853 },
  { name:"Farmgate",     lat:23.7573, lng:90.3918 },
  { name:"Tejgaon",      lat:23.7673, lng:90.3992 },
  { name:"Khilgaon",     lat:23.7465, lng:90.4295 },
  { name:"Demra",        lat:23.7211, lng:90.4671 },
  { name:"Jatrabari",    lat:23.7117, lng:90.4333 },
  { name:"Sadarghat",    lat:23.7102, lng:90.4085 },
  { name:"Paltan",       lat:23.7330, lng:90.4130 },
  { name:"Karwan Bazar", lat:23.7516, lng:90.3932 },
];

const MOCK_DRIVERS = [
  { id:"d1", name:"Karim Hossain",   rating:4.8, vehicle:"Toyota Axio",  plate:"Dhaka Metro-Ga 11-2234", location:{lat:23.7860,lng:90.4100}, phone:"+880 1712 345678" },
  { id:"d2", name:"Rahim Uddin",     rating:4.6, vehicle:"Honda Fit",    plate:"Dhaka Metro-Ka 22-5567", location:{lat:23.7750,lng:90.4050}, phone:"+880 1812 456789" },
  { id:"d3", name:"Shahidul Islam",  rating:4.9, vehicle:"Suzuki Swift", plate:"Dhaka Metro-Kha 33-8890",location:{lat:23.7900,lng:90.4200}, phone:"+880 1912 567890" },
];

const RIDER_NAMES = ["Amin Hossain","Fatema Begum","Rakib Hassan","Nusrat Jahan","Sohel Rana"];
const VEHICLE_TYPES = [
  { id:"bike", label:"Moto",  emoji:"ğŸï¸", desc:"Fastest & cheapest", mult:1   },
  { id:"car",  label:"Car",   emoji:"ğŸš—", desc:"Comfortable ride",   mult:2.2 },
  { id:"cng",  label:"CNG",   emoji:"ğŸ›º", desc:"Auto rickshaw",      mult:1.5 },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode = "rider";
let sidebarOpen = true;

// rider
let rideStatus = "idle";
let pickup = null, dropoff = null;
let pickupName = "", dropoffName = "";
let isSelectingPickup = false, isSelectingDropoff = false;
let activeRequest = null, assignedDriver = null, driverLocation = null;
let selectedVehicle = "car";

// driver
let driverOnline = false;
let pendingRequests = [];
let driverActiveRide = null;
let earnings = 0, ridesCompleted = 0;
let driverTab = "requests";

// anim
let driverAnimInterval = null;
let driverRequestInterval = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAP SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { center: DHAKA_CENTER, zoom: 13, zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19,
}).addTo(map);

// Fix map size after fonts/styles load + request geolocation
window.addEventListener('load', () => {
  map.invalidateSize();
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;
        map.setView([lat, lng], 15);
        // Update location badge
        const badge = document.querySelector('#map-area > div:nth-child(2) span:last-child');
        if (badge) badge.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        // Auto-set pickup to user's real location
        setPickup({ lat, lng }, 'My Location');
        updateMapLayers(); render();
        // Place a blue dot for user location
        L.circleMarker([lat, lng], { radius: 10, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 0.5, weight: 3 })
          .addTo(map)
          .bindPopup('<b>ğŸ“ You are here</b>');
      },
      () => { /* permission denied or unavailable â€” stay on Dhaka default */ }
    );
  }
});
// Also fix on any resize (bottom sheet toggling etc.)
window.addEventListener('resize', () => { map.invalidateSize(); });

let pickupMarker=null, dropoffMarker=null, driverMarker=null;
let routeLine=null, driverLine=null;
let pickupCircle=null, dropoffCircle=null, userMarker=null;
let pendingMarkers=[], idleDriverMarkers=[];

map.on('click', function(e) {
  if (isSelectingPickup) {
    setPickup({ lat: e.latlng.lat, lng: e.latlng.lng },
              `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
    isSelectingPickup = false;
    updateMapCursor(); hideHint(); render();
  } else if (isSelectingDropoff) {
    setDropoff({ lat: e.latlng.lat, lng: e.latlng.lng },
               `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
    isSelectingDropoff = false;
    updateMapCursor(); hideHint(); render();
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ICON FACTORIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function coloredPin(color, size=36) {
  return L.divIcon({
    html: `<div style="width:${size}px;height:${size}px;background:${color};border:3px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 4px 12px rgba(0,0,0,.3);position:relative;">
             <div style="position:absolute;inset:4px;background:white;border-radius:50%;transform:rotate(45deg);"></div>
           </div>`,
    iconSize:[size,size], iconAnchor:[size/2,size], className:""
  });
}
function carIcon(color='#16a34a') {
  return L.divIcon({
    html: `<div style="background:${color};border:2.5px solid white;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.25);font-size:18px;">ğŸš—</div>`,
    iconSize:[38,38], iconAnchor:[19,19], className:""
  });
}
function riderIcon() {
  return L.divIcon({
    html: `<div style="background:#2563eb;border:2.5px solid white;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.25);font-size:18px;">ğŸ‘¤</div>`,
    iconSize:[38,38], iconAnchor:[19,19], className:""
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DISTANCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcDist(a, b) {
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const x=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAP LAYERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearLayer(l) { if (l) { try { map.removeLayer(l); } catch(e){} } }

function updateMapLayers() {
  clearLayer(pickupMarker); clearLayer(dropoffMarker); clearLayer(driverMarker);
  clearLayer(routeLine); clearLayer(driverLine);
  clearLayer(pickupCircle); clearLayer(dropoffCircle); clearLayer(userMarker);
  pendingMarkers.forEach(m=>clearLayer(m)); pendingMarkers=[];
  idleDriverMarkers.forEach(m=>clearLayer(m)); idleDriverMarkers=[];

  const dhaka = { lat:DHAKA_CENTER[0], lng:DHAKA_CENTER[1] };

  if (mode==='driver') {
    userMarker=L.marker([dhaka.lat,dhaka.lng],{icon:carIcon('#16a34a')})
      .addTo(map).bindPopup('<div style="font-weight:600;">ğŸ“ Your Location (Driver)</div>');
    pendingRequests.forEach(req=>{
      const m=L.marker([req.pickup.lat,req.pickup.lng],{icon:coloredPin('#f59e0b',32)})
        .addTo(map)
        .bindPopup(`<div style="font-weight:600;">ğŸ”” Ride Request</div>
                    <div style="font-size:12px;">From: ${req.pickupName}</div>
                    <div style="font-size:12px;">To: ${req.dropoffName}</div>
                    <div style="font-size:12px;font-weight:700;color:#16a34a;">à§³${req.fare}</div>`);
      pendingMarkers.push(m);
    });
    return;
  }

  // RIDER
  if (!pickup) {
    userMarker=L.marker([dhaka.lat,dhaka.lng],{icon:riderIcon()}).addTo(map).bindPopup('You are here');
    if (!driverLocation) {
      MOCK_DRIVERS.forEach(d=>{
        const m=L.marker([d.location.lat,d.location.lng],{icon:carIcon('#6b7280')})
          .addTo(map)
          .bindPopup(`<div style="font-size:13px;font-weight:600;">${d.name}</div><div style="font-size:11px;color:#6b7280;">Available</div>`);
        idleDriverMarkers.push(m);
      });
    }
  }

  if (pickup) {
    pickupMarker=L.marker([pickup.lat,pickup.lng],{icon:coloredPin('#16a34a')})
      .addTo(map)
      .bindPopup(`<div style="font-weight:600;color:#15803d;">ğŸŸ¢ Pickup</div><div style="font-size:12px;">${pickupName||'Selected'}</div>`);
    pickupCircle=L.circle([pickup.lat,pickup.lng],{radius:80,color:'#16a34a',fillColor:'#16a34a',fillOpacity:.1,weight:1}).addTo(map);
  }

  if (dropoff) {
    dropoffMarker=L.marker([dropoff.lat,dropoff.lng],{icon:coloredPin('#dc2626')})
      .addTo(map)
      .bindPopup(`<div style="font-weight:600;color:#dc2626;">ğŸ”´ Destination</div><div style="font-size:12px;">${dropoffName||'Selected'}</div>`);
    dropoffCircle=L.circle([dropoff.lat,dropoff.lng],{radius:80,color:'#dc2626',fillColor:'#dc2626',fillOpacity:.1,weight:1}).addTo(map);
  }

  if (pickup&&dropoff) {
    routeLine=L.polyline([[pickup.lat,pickup.lng],[dropoff.lat,dropoff.lng]],{color:'#16a34a',weight:4,opacity:.7,dashArray:'8 4'}).addTo(map);
  }

  if (driverLocation) {
    driverMarker=L.marker([driverLocation.lat,driverLocation.lng],{icon:carIcon('#16a34a')})
      .addTo(map)
      .bindPopup('<div style="font-weight:600;">ğŸš— Your Driver</div><div style="font-size:12px;color:#16a34a;">On the way!</div>');
    if (pickup) {
      driverLine=L.polyline([[driverLocation.lat,driverLocation.lng],[pickup.lat,pickup.lng]],{color:'#2563eb',weight:3,opacity:.6,dashArray:'6 4'}).addTo(map);
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CURSOR / HINT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateMapCursor() {
  const el=document.getElementById('map');
  if (isSelectingPickup||isSelectingDropoff) el.classList.add('cursor-cross');
  else el.classList.remove('cursor-cross');
}
function showHint(txt) { const h=document.getElementById('map-hint'); h.textContent=txt; h.style.display='block'; }
function hideHint() { document.getElementById('map-hint').style.display='none'; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOCATION HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPickup(latlng,name) { pickup=latlng; pickupName=name; }
function setDropoff(latlng,name) { dropoff=latlng; dropoffName=name; }

function estFare() {
  if (!pickup||!dropoff) return 0;
  const dist=calcDist(pickup,dropoff);
  const mult=VEHICLE_TYPES.find(v=>v.id===selectedVehicle).mult;
  return Math.floor(dist*25*mult+80);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SEARCH (persistent inputs â€” never destroyed)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLocationResults(containerId, locs, onSelect) {
  const c = document.getElementById(containerId);
  if (!c) return;
  c.innerHTML = locs.length
    ? locs.map(l => `
      <button onclick="${onSelect}('${l.name.replace(/'/g,"\\'")}',${l.lat},${l.lng})"
        style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 14px;border:none;background:white;cursor:pointer;text-align:left;font-size:13px;border-bottom:1px solid #f1f5f9;"
        onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
        <span style="color:hsl(142,72%,35%);">ğŸ“</span>${l.name}
      </button>`).join('')
    : `<div style="padding:14px;text-align:center;color:#94a3b8;font-size:13px;">No locations found</div>`;
}

function openPickupList() {
  document.getElementById('pickup-search-wrap').classList.add('visible');
  document.getElementById('dropoff-search-wrap').classList.remove('visible');
  filterPickup(document.getElementById('pickup-search-input').value);
  setTimeout(()=>document.getElementById('pickup-search-input').focus(), 80);
}
function closePickupList() {
  document.getElementById('pickup-search-wrap').classList.remove('visible');
}
function filterPickup(val) {
  const locs = DHAKA_LOCATIONS.filter(l=>l.name.toLowerCase().includes(val.toLowerCase()));
  renderLocationResults('pickup-results', locs, 'selectPickupLoc');
  // Show hint if user typed something not in list
  const hint = document.getElementById('pickup-hint');
  if (hint) hint.style.display = val.trim() && locs.length === 0 ? 'block' : 'none';
}
function handlePickupKey(e) {
  if (e.key === 'Enter') { e.preventDefault(); submitPickupText(); }
}
function submitPickupText() {
  const val = document.getElementById('pickup-search-input').value.trim();
  if (!val) return;
  // Use Nominatim geocoding to resolve to coordinates, fall back to map center
  const encodedVal = encodeURIComponent(val + ', Bangladesh');
  fetch(`https://nominatim.openstreetmap.org/search?q=${encodedVal}&format=json&limit=1`)
    .then(r=>r.json())
    .then(data=>{
      if (data && data[0]) {
        selectPickupLoc(val, parseFloat(data[0].lat), parseFloat(data[0].lon));
        map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 15);
      } else {
        // Fallback: use current map center
        const c = map.getCenter();
        selectPickupLoc(val, c.lat, c.lng);
      }
    })
    .catch(()=>{
      const c = map.getCenter();
      selectPickupLoc(val, c.lat, c.lng);
    });
}

function openDropoffList() {
  document.getElementById('dropoff-search-wrap').classList.add('visible');
  document.getElementById('pickup-search-wrap').classList.remove('visible');
  filterDropoff(document.getElementById('dropoff-search-input').value);
  setTimeout(()=>document.getElementById('dropoff-search-input').focus(), 80);
}
function closeDropoffList() {
  document.getElementById('dropoff-search-wrap').classList.remove('visible');
}
function filterDropoff(val) {
  const locs = DHAKA_LOCATIONS.filter(l=>l.name.toLowerCase().includes(val.toLowerCase()));
  renderLocationResults('dropoff-results', locs, 'selectDropoffLoc');
  const hint = document.getElementById('dropoff-hint');
  if (hint) hint.style.display = val.trim() && locs.length === 0 ? 'block' : 'none';
}
function handleDropoffKey(e) {
  if (e.key === 'Enter') { e.preventDefault(); submitDropoffText(); }
}
function submitDropoffText() {
  const val = document.getElementById('dropoff-search-input').value.trim();
  if (!val) return;
  const encodedVal = encodeURIComponent(val + ', Bangladesh');
  fetch(`https://nominatim.openstreetmap.org/search?q=${encodedVal}&format=json&limit=1`)
    .then(r=>r.json())
    .then(data=>{
      if (data && data[0]) {
        selectDropoffLoc(val, parseFloat(data[0].lat), parseFloat(data[0].lon));
        map.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 15);
      } else {
        const c = map.getCenter();
        selectDropoffLoc(val, c.lat, c.lng);
      }
    })
    .catch(()=>{
      const c = map.getCenter();
      selectDropoffLoc(val, c.lat, c.lng);
    });
}

function selectPickupLoc(name,lat,lng) {
  setPickup({lat,lng},name);
  closePickupList();
  isSelectingPickup=false; updateMapCursor(); hideHint();
  document.getElementById('pickup-search-input').value = '';
  document.getElementById('pickup-hint').style.display = 'none';
  updateMapLayers(); render();
}
function selectDropoffLoc(name,lat,lng) {
  setDropoff({lat,lng},name);
  closeDropoffList();
  isSelectingDropoff=false; updateMapCursor(); hideHint();
  document.getElementById('dropoff-search-input').value = '';
  document.getElementById('dropoff-hint').style.display = 'none';
  updateMapLayers(); render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RIDE ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestRide() {
  if (!pickup||!dropoff) return;
  const dist=calcDist(pickup,dropoff);
  const mult=VEHICLE_TYPES.find(v=>v.id===selectedVehicle).mult;
  const fare=Math.floor(dist*25*mult+80);
  activeRequest={ id:`req-${Date.now()}`, riderId:'self', riderName:'You',
    pickup, pickupName, dropoff, dropoffName, fare,
    distance:`${dist.toFixed(1)} km`, status:'pending', requestedAt:new Date() };
  rideStatus='searching'; render();

  setTimeout(()=>{
    assignedDriver=MOCK_DRIVERS[Math.floor(Math.random()*MOCK_DRIVERS.length)];
    driverLocation={...assignedDriver.location};
    rideStatus='accepted'; updateMapLayers(); render();
    simulateDriverMovement(assignedDriver.location,pickup,()=>{
      rideStatus='en_route'; render();
      simulateDriverMovement(pickup,dropoff,()=>{});
    });
  }, Math.random()*3000+4000);
}

function cancelRide() {
  rideStatus='idle'; pickup=null; dropoff=null; pickupName=''; dropoffName='';
  activeRequest=null; assignedDriver=null; driverLocation=null;
  if (driverAnimInterval) clearInterval(driverAnimInterval);
  updateMapLayers(); render();
}

function completeRide() {
  rideStatus='completed';
  if (driverAnimInterval) clearInterval(driverAnimInterval);
  render();
}

function simulateDriverMovement(from,to,onDone) {
  if (driverAnimInterval) clearInterval(driverAnimInterval);
  let progress=0;
  driverAnimInterval=setInterval(()=>{
    progress+=0.04;
    if (progress>=1) {
      progress=1; clearInterval(driverAnimInterval);
      driverLocation={...to}; updateMapLayers(); onDone();
    } else {
      driverLocation={ lat:from.lat+(to.lat-from.lat)*progress, lng:from.lng+(to.lng-from.lng)*progress };
      if (driverMarker) {
        driverMarker.setLatLng([driverLocation.lat,driverLocation.lng]);
        if (driverLine&&pickup) driverLine.setLatLngs([[driverLocation.lat,driverLocation.lng],[pickup.lat,pickup.lng]]);
      }
    }
  }, 400);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DRIVER ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDriverOnline() {
  driverOnline=!driverOnline;
  if (driverOnline) startDriverRequestInterval();
  else { if (driverRequestInterval) clearInterval(driverRequestInterval); pendingRequests=[]; }
  render();
}

function startDriverRequestInterval() {
  if (driverRequestInterval) clearInterval(driverRequestInterval);
  driverRequestInterval=setInterval(()=>{
    if (!driverOnline||driverActiveRide) return;
    const src=MOCK_DRIVERS[Math.floor(Math.random()*MOCK_DRIVERS.length)].location;
    const dropoffOpts=[
      {lat:23.7461,lng:90.3742,name:'Dhanmondi'},
      {lat:23.8759,lng:90.3795,name:'Uttara'},
      {lat:23.7274,lng:90.4173,name:'Motijheel'},
    ];
    const pNames=["Gulshan 2","Banani","Bashundhara"];
    const d=dropoffOpts[Math.floor(Math.random()*dropoffOpts.length)];
    const dist=calcDist(src,d);
    const fare=Math.floor(dist*25+60);
    const req={
      id:`req-${Date.now()}`, riderId:`rider-${Math.random()}`,
      riderName:RIDER_NAMES[Math.floor(Math.random()*RIDER_NAMES.length)],
      pickup:src, pickupName:pNames[Math.floor(Math.random()*pNames.length)],
      dropoff:d, dropoffName:d.name, fare, distance:`${dist.toFixed(1)} km`,
      status:'pending', requestedAt:new Date()
    };
    pendingRequests=[...pendingRequests.slice(-2),req];
    updateMapLayers(); render();
  }, 8000);
}

function acceptRide(reqId) {
  const req=pendingRequests.find(r=>r.id===reqId);
  if (!req) return;
  driverActiveRide=req; pendingRequests=[];
  updateMapLayers(); render();
}
function declineRide(reqId) {
  pendingRequests=pendingRequests.filter(r=>r.id!==reqId);
  updateMapLayers(); render();
}
function driverCompleteRide() {
  if (!driverActiveRide) return;
  earnings+=driverActiveRide.fare; ridesCompleted++;
  driverActiveRide=null; render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(m) {
  mode=m; isSelectingPickup=false; isSelectingDropoff=false;
  closePickupList(); closeDropoffList();
  updateMapCursor(); hideHint(); updateMapLayers(); render();
}

function toggleSidebar() {
  sidebarOpen=!sidebarOpen;
  const sb=document.getElementById('sidebar');
  sb.classList.toggle('hidden-desk',!sidebarOpen);
  document.getElementById('sidebar-toggle').textContent=sidebarOpen?'âœ•':'â˜°';
  setTimeout(()=>map.invalidateSize(),320);
}

function setVehicle(v) { selectedVehicle=v; render(); }
function setDriverTab(t) { driverTab=t; render(); }

function startSelectPickup() {
  isSelectingPickup=true; isSelectingDropoff=false;
  closePickupList(); closeDropoffList();
  updateMapCursor(); showHint('ğŸ“ Click to set pickup location'); render();
}
function startSelectDropoff() {
  isSelectingDropoff=true; isSelectingPickup=false;
  closePickupList(); closeDropoffList();
  updateMapCursor(); showHint('ğŸ¯ Click to set destination'); render();
}

function clearPickup()  { pickup=null; pickupName=''; isSelectingPickup=false; updateMapCursor(); hideHint(); render(); }
function clearDropoff() { dropoff=null; dropoffName=''; isSelectingDropoff=false; updateMapCursor(); hideHint(); render(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER: RIDER PANEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRiderPanel() {
  if (rideStatus==='accepted'||rideStatus==='en_route') {
    return `
    <div class="anim-slide-up" style="display:flex;flex-direction:column;gap:14px;">
      <div style="background:hsl(142,72%,35%);color:white;border-radius:16px;padding:16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="width:8px;height:8px;background:white;border-radius:50%;"></div>
          <span style="font-size:13px;font-weight:500;opacity:.9;">${rideStatus==='accepted'?'Driver is on the way':"You're en route!"}</span>
        </div>
        <div style="font-size:18px;font-weight:800;">${assignedDriver?.name}</div>
        <div style="font-size:12px;opacity:.8;">${assignedDriver?.vehicle} Â· ${assignedDriver?.plate}</div>
      </div>
      <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="color:#f59e0b;">â˜…</span>
            <span style="font-weight:600;">${assignedDriver?.rating}</span>
            <span style="color:#64748b;font-size:13px;">rating</span>
          </div>
          <a href="tel:${assignedDriver?.phone}" style="display:flex;align-items:center;gap:5px;background:hsl(142,72%,35%);color:white;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600;text-decoration:none;">ğŸ“ Call</a>
        </div>
        <div style="font-size:13px;color:#64748b;display:flex;flex-direction:column;gap:6px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:8px;height:8px;background:hsl(142,72%,35%);border-radius:50%;flex-shrink:0;"></div>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${pickupName}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:8px;height:8px;background:#dc2626;border-radius:50%;flex-shrink:0;"></div>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${dropoffName}</span>
          </div>
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
          <span style="color:#64748b;font-size:13px;">Estimated fare</span>
          <span style="font-weight:700;font-size:15px;">à§³${activeRequest?.fare}</span>
        </div>
      </div>
      ${rideStatus==='en_route'?`<button onclick="completeRide()" style="width:100%;padding:14px;background:hsl(142,72%,35%);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">âœ“ Complete Ride</button>`:''}
      <button onclick="cancelRide()" style="width:100%;padding:12px;background:white;color:#dc2626;border:1px solid rgba(220,38,38,.3);border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;">Cancel Ride</button>
    </div>`;
  }

  if (rideStatus==='searching') {
    return `
    <div class="anim-fade-in" style="display:flex;flex-direction:column;align-items:center;gap:20px;padding:24px 0;">
      <div style="position:relative;width:80px;height:80px;">
        <div class="ping-anim" style="position:absolute;inset:0;border-radius:50%;background:hsl(142,72%,35%,.2);"></div>
        <div class="ping-anim" style="position:absolute;inset:8px;border-radius:50%;background:hsl(142,72%,35%,.3);animation-delay:.3s;"></div>
        <div style="position:relative;width:100%;height:100%;border-radius:50%;background:hsl(142,72%,35%);display:flex;align-items:center;justify-content:center;font-size:32px;">ğŸš—</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:17px;font-weight:700;">Finding your driver...</div>
        <div style="color:#64748b;font-size:13px;margin-top:4px;">Usually takes 1â€“3 minutes in Dhaka</div>
      </div>
      <div style="width:100%;background:#f1f5f9;border-radius:16px;padding:14px;font-size:13px;display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">From</span><span style="font-weight:600;max-width:60%;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${pickupName}</span></div>
        <div style="display:flex;justify-content:space-between;"><span style="color:#64748b;">To</span><span style="font-weight:600;max-width:60%;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${dropoffName}</span></div>
      </div>
      <button onclick="cancelRide()" style="width:100%;padding:12px;background:white;color:#dc2626;border:1px solid rgba(220,38,38,.3);border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;">Cancel Search</button>
    </div>`;
  }

  if (rideStatus==='completed') {
    return `
    <div class="anim-slide-up" style="display:flex;flex-direction:column;align-items:center;gap:18px;padding:24px 0;">
      <div style="width:64px;height:64px;background:hsl(142,72%,35%,.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;">âœ…</div>
      <div style="text-align:center;">
        <div style="font-size:20px;font-weight:800;">Ride Complete!</div>
        <div style="color:#64748b;font-size:13px;margin-top:4px;">Hope you had a great experience</div>
      </div>
      <div style="width:100%;background:#f1f5f9;border-radius:16px;padding:16px;text-align:center;">
        <div style="color:#64748b;font-size:13px;">Total Paid</div>
        <div style="font-size:32px;font-weight:800;color:hsl(142,72%,35%);">à§³${activeRequest?.fare}</div>
      </div>
      <button onclick="cancelRide()" style="width:100%;padding:14px;background:hsl(142,72%,35%);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">Book Another Ride</button>
    </div>`;
  }

  // IDLE
  const fare = estFare();
  return `
  <div class="anim-slide-up" style="display:flex;flex-direction:column;gap:14px;">
    <div>
      <div style="font-size:18px;font-weight:800;">Where are you going?</div>
      <div style="color:#64748b;font-size:13px;">Set your pickup &amp; destination</div>
    </div>

    <!-- PICKUP -->
    <div>
      <div onclick="startSelectPickup()"
        style="display:flex;align-items:center;gap:12px;padding:13px;border-radius:12px;border:2px solid ${isSelectingPickup?'hsl(142,72%,35%)':'#e2e8f0'};background:${isSelectingPickup?'hsl(142,72%,35%,.05)':'white'};cursor:pointer;transition:all .2s;">
        <div style="width:11px;height:11px;background:hsl(142,72%,35%);border-radius:50%;flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:10px;font-weight:600;color:#94a3b8;letter-spacing:.05em;">PICKUP</div>
          ${pickupName
            ? `<div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${pickupName}</div>`
            : `<div style="font-size:13px;color:#94a3b8;">Tap map or search below</div>`}
        </div>
        ${pickup ? `<button onclick="event.stopPropagation();clearPickup()" style="background:none;border:none;cursor:pointer;color:#94a3b8;font-size:16px;line-height:1;padding:0 2px;">âœ•</button>` : ''}
      </div>
      ${!pickup ? `<button onclick="openPickupList()" style="margin-top:6px;width:100%;padding:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;color:#64748b;cursor:pointer;text-align:left;padding-left:12px;">ğŸ” Search pickup location...</button>` : ''}
    </div>

    <!-- DROPOFF -->
    <div>
      <div onclick="startSelectDropoff()"
        style="display:flex;align-items:center;gap:12px;padding:13px;border-radius:12px;border:2px solid ${isSelectingDropoff?'#dc2626':'#e2e8f0'};background:${isSelectingDropoff?'rgba(220,38,38,.05)':'white'};cursor:pointer;transition:all .2s;">
        <div style="width:11px;height:11px;background:#dc2626;border-radius:50%;flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:10px;font-weight:600;color:#94a3b8;letter-spacing:.05em;">DESTINATION</div>
          ${dropoffName
            ? `<div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${dropoffName}</div>`
            : `<div style="font-size:13px;color:#94a3b8;">Tap map or search below</div>`}
        </div>
        ${dropoff ? `<button onclick="event.stopPropagation();clearDropoff()" style="background:none;border:none;cursor:pointer;color:#94a3b8;font-size:16px;line-height:1;padding:0 2px;">âœ•</button>` : ''}
      </div>
      ${!dropoff ? `<button onclick="openDropoffList()" style="margin-top:6px;width:100%;padding:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;color:#64748b;cursor:pointer;text-align:left;padding-left:12px;">ğŸ” Search destination...</button>` : ''}
    </div>

    <!-- Vehicle picker -->
    ${pickup&&dropoff ? `
    <div class="anim-slide-up">
      <div style="font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;">Choose Vehicle</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        ${VEHICLE_TYPES.map(v=>`
        <button onclick="setVehicle('${v.id}')" style="display:flex;flex-direction:column;align-items:center;padding:12px 8px;border-radius:12px;border:2px solid ${selectedVehicle===v.id?'hsl(142,72%,35%)':'#e2e8f0'};background:${selectedVehicle===v.id?'hsl(142,72%,35%,.08)':'white'};cursor:pointer;transition:all .2s;">
          <span style="font-size:22px;">${v.emoji}</span>
          <span style="font-size:12px;font-weight:700;margin-top:4px;">${v.label}</span>
          <span style="font-size:11px;color:#64748b;">à§³${Math.floor(80*v.mult)}+</span>
        </button>`).join('')}
      </div>
      <div style="margin-top:10px;background:#f1f5f9;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;">
        <div style="color:#64748b;font-size:13px;">â± ~15 min</div>
        <div style="text-align:right;">
          <div style="font-size:11px;color:#64748b;">Estimated</div>
          <div style="font-weight:700;font-size:16px;">à§³${fare}</div>
        </div>
      </div>
    </div>` : ''}

    <!-- CTA -->
    ${pickup&&dropoff
      ? `<button onclick="requestRide()" style="width:100%;padding:15px;background:hsl(142,72%,35%);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px hsl(142,72%,35%,.4);">Request Ride â€º</button>`
      : `<div style="background:#f1f5f9;border-radius:12px;padding:12px;text-align:center;font-size:13px;color:#64748b;">${!pickup?'Set your pickup location to continue':'Set your destination to continue'}</div>`
    }
  </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER: DRIVER PANEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDriverPanel() {
  if (driverActiveRide) {
    const r=driverActiveRide;
    return `
    <div class="anim-slide-up" style="display:flex;flex-direction:column;gap:14px;">
      <div style="background:hsl(142,72%,35%);color:white;border-radius:16px;padding:16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="width:8px;height:8px;background:white;border-radius:50%;"></div>
          <span style="font-size:13px;opacity:.9;font-weight:500;">Active Ride</span>
        </div>
        <div style="font-size:17px;font-weight:800;">${r.riderName}</div>
        <div style="font-size:13px;opacity:.8;">Fare: à§³${r.fare}</div>
      </div>
      <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;align-items:flex-start;gap:12px;">
          <div style="width:10px;height:10px;background:hsl(142,72%,35%);border-radius:50%;margin-top:3px;flex-shrink:0;"></div>
          <div><div style="font-size:10px;color:#94a3b8;font-weight:600;">PICKUP</div><div style="font-size:13px;font-weight:600;">${r.pickupName}</div></div>
        </div>
        <div style="width:1px;height:18px;background:#e2e8f0;margin-left:4px;"></div>
        <div style="display:flex;align-items:flex-start;gap:12px;">
          <div style="width:10px;height:10px;background:#dc2626;border-radius:50%;margin-top:3px;flex-shrink:0;"></div>
          <div><div style="font-size:10px;color:#94a3b8;font-weight:600;">DESTINATION</div><div style="font-size:13px;font-weight:600;">${r.dropoffName}</div></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="background:#f1f5f9;border-radius:12px;padding:12px;text-align:center;">
          <div style="font-size:11px;color:#64748b;">Distance</div>
          <div style="font-weight:700;">${r.distance}</div>
        </div>
        <div style="background:#f1f5f9;border-radius:12px;padding:12px;text-align:center;">
          <div style="font-size:11px;color:#64748b;">Earnings</div>
          <div style="font-weight:700;color:hsl(142,72%,35%);">à§³${r.fare}</div>
        </div>
      </div>
      <button onclick="driverCompleteRide()" style="width:100%;padding:14px;background:hsl(142,72%,35%);color:white;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;">âœ“ Complete Ride</button>
    </div>`;
  }

  return `
  <div style="display:flex;flex-direction:column;gap:14px;">
    <div style="border-radius:16px;padding:16px;display:flex;align-items:center;justify-content:space-between;border:2px solid ${driverOnline?'hsl(142,72%,35%)':'#e2e8f0'};background:${driverOnline?'hsl(142,72%,35%,.06)':'#f8fafc'};">
      <div>
        <div style="font-weight:700;">${driverOnline?"ğŸŸ¢ You're Online":"â­• You're Offline"}</div>
        <div style="font-size:12px;color:#64748b;margin-top:2px;">${driverOnline?'Ready to accept rides':'Go online to receive requests'}</div>
      </div>
      <div onclick="toggleDriverOnline()" class="toggle-track" style="background:${driverOnline?'hsl(142,72%,35%)':'#cbd5e1'};">
        <div class="toggle-thumb" style="left:${driverOnline?'31px':'3px'};"></div>
      </div>
    </div>
    <div style="display:flex;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;">
      <button onclick="setDriverTab('requests')" style="flex:1;padding:10px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;background:${driverTab==='requests'?'hsl(142,72%,35%)':'white'};color:${driverTab==='requests'?'white':'#64748b'};">
        Requests (${pendingRequests.length})
      </button>
      <button onclick="setDriverTab('stats')" style="flex:1;padding:10px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;background:${driverTab==='stats'?'hsl(142,72%,35%)':'white'};color:${driverTab==='stats'?'white':'#64748b'};">
        Earnings
      </button>
    </div>
    ${driverTab==='requests' ? renderDriverRequests() : renderDriverStats()}
  </div>`;
}

function renderDriverRequests() {
  if (!driverOnline) return `
    <div style="text-align:center;padding:32px 0;">
      <div style="font-size:40px;margin-bottom:12px;">ğŸš—</div>
      <div style="color:#64748b;font-weight:500;">Go online to see ride requests</div>
    </div>`;

  if (pendingRequests.length===0) return `
    <div class="anim-fade-in" style="text-align:center;padding:32px 0;">
      <div style="width:48px;height:48px;background:#f1f5f9;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:22px;">â±</div>
      <div style="font-weight:600;">Waiting for requests...</div>
      <div style="font-size:13px;color:#64748b;margin-top:4px;">Ride requests will appear here</div>
    </div>`;

  return pendingRequests.map(req=>`
    <div class="anim-slide-up" style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
        <div>
          <div style="font-weight:700;">${req.riderName}</div>
          <div style="font-size:12px;color:#64748b;">${req.distance} away</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:800;font-size:18px;color:hsl(142,72%,35%);">à§³${req.fare}</div>
          <div style="font-size:11px;color:#94a3b8;">estimated</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;font-size:13px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:8px;height:8px;background:hsl(142,72%,35%);border-radius:50%;flex-shrink:0;"></div>
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${req.pickupName}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:8px;height:8px;background:#dc2626;border-radius:50%;flex-shrink:0;"></div>
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${req.dropoffName}</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="declineRide('${req.id}')" style="flex:1;padding:10px;background:white;color:#dc2626;border:1px solid rgba(220,38,38,.3);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">âœ• Decline</button>
        <button onclick="acceptRide('${req.id}')" style="flex:1;padding:10px;background:hsl(142,72%,35%);color:white;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;">âœ“ Accept</button>
      </div>
    </div>`).join('');
}

function renderDriverStats() {
  return `
  <div class="anim-fade-in" style="display:flex;flex-direction:column;gap:12px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:16px;text-align:center;">
        <div style="font-size:22px;margin-bottom:6px;">ğŸ“ˆ</div>
        <div style="font-size:24px;font-weight:800;">à§³${earnings}</div>
        <div style="font-size:11px;color:#64748b;">Today's Earnings</div>
      </div>
      <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:16px;text-align:center;">
        <div style="font-size:22px;margin-bottom:6px;">ğŸš—</div>
        <div style="font-size:24px;font-weight:800;">${ridesCompleted}</div>
        <div style="font-size:11px;color:#64748b;">Rides Completed</div>
      </div>
    </div>
    <div style="background:hsl(142,72%,35%,.08);border:1px solid hsl(142,72%,35%,.2);border-radius:14px;padding:14px;">
      <div style="font-size:13px;font-weight:700;color:hsl(142,72%,35%);margin-bottom:4px;">ğŸ’¡ Dhaka Peak Hours</div>
      <div style="font-size:12px;color:#64748b;">8â€“10am and 5â€“8pm are the busiest. Stay online to earn more!</div>
    </div>
    <div style="background:white;border:1px solid #e2e8f0;border-radius:14px;padding:14px;">
      <div style="font-size:13px;font-weight:700;margin-bottom:10px;">Surge Areas</div>
      ${['Gulshan','Dhanmondi','Motijheel'].map(area=>`
      <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;padding:4px 0;">
        <span style="color:#64748b;">${area}</span>
        <span style="font-weight:700;color:hsl(142,72%,35%);">1.5Ã— surge</span>
      </div>`).join('')}
    </div>
  </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const green='hsl(142,72%,35%)', muted='#f1f5f9', mutedTxt='#64748b';
  const rBtn=document.getElementById('btn-rider-mode');
  const dBtn=document.getElementById('btn-driver-mode');
  if (rBtn) { rBtn.style.background=mode==='rider'?green:muted; rBtn.style.color=mode==='rider'?'white':mutedTxt; }
  if (dBtn) { dBtn.style.background=mode==='driver'?green:muted; dBtn.style.color=mode==='driver'?'white':mutedTxt; }

  document.getElementById('panel-content').innerHTML =
    mode==='rider' ? renderRiderPanel() : renderDriverPanel();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
// Seed pickup results so list is ready
filterPickup('');
filterDropoff('');
</script>



</body>
</html>
